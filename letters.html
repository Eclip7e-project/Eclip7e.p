<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Letters Wall - RII7E Project</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{
    --gold:#d4af37;
    --bg:#000;
  }
  html,body{height:100%;margin:0;font-family:'Playfair Display',serif;background:var(--bg);color:#fff;text-align:center}
  header{display:flex;flex-direction:column;align-items:center;background:#000;border-bottom:2px solid var(--gold);padding-bottom:6px}
  header img.banner{width:100%;height:auto;object-fit:contain;border-bottom:2px solid var(--gold)}
  .header-text{padding:20px}
  .header-text h1{color:var(--gold);margin:8px 0;font-size:2.2rem}
  .header-text p{max-width:700px;margin:0 auto;color:#fff}

  /* WALL */
  section.wall{display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-start;padding:28px}
  .sticky-note{width:160px;height:240px;position:relative;border-radius:14px;overflow:hidden;cursor:pointer;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
  .sticky-note img{width:100%;height:100%;object-fit:cover;display:block}
  .sticky-note .label{position:absolute;bottom:8px;left:8px;right:8px;background:rgba(255,255,255,0.85);color:#000;padding:6px;border-radius:8px;font-size:0.75rem;white-space:pre-wrap;overflow:hidden;text-overflow:ellipsis;max-height:72px}

  /* top highlight */
  .top-note{border:4px solid var(--gold);box-shadow:0 0 18px var(--gold)}

  /* MODAL */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;z-index:9999;padding:18px}
  #modal-inner{background:transparent;max-width:1100px;width:100%;max-height:95vh;border-radius:12px;display:flex;gap:18px;align-items:stretch}
  /* left: letter image */
  .modal-left{flex:0 1 560px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;position:relative}
  .modal-left .letter-frame{width:100%;max-width:560px;height:calc(100vh - 200px);max-height:760px;border-radius:12px;overflow:hidden;position:relative;background:#fff}
  .modal-left .letter-frame img{width:100%;height:100%;object-fit:cover;display:block}
  /* overlay text centered on letter */
  #modal-text{position:absolute;left:20px;right:20px;top:24px;bottom:24px;display:flex;align-items:center;justify-content:center;pointer-events:none;white-space:pre-wrap;text-align:center;padding:14px}
  #modal-text p{margin:0;font-size:1rem;line-height:1.3;font-weight:600;text-shadow:0 1px 4px rgba(0,0,0,0.6)}
  /* controls under letter */
  .modal-controls{margin-top:12px;display:flex;gap:8px;justify-content:center;width:100%}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-like{background:var(--gold);color:#000}
  .btn-delete{background:#e74c3c;color:#fff}
  .btn-close{position:absolute;top:10px;right:10px;background:#e74c3c;color:#fff;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;z-index:30}

  /* right: comments panel (white/neutral) */
  .modal-right{flex:0 1 380px;background:#fff;border-radius:12px;padding:12px;color:#000;display:flex;flex-direction:column;gap:12px;max-height:90vh;overflow:hidden}
  .comments-title{font-weight:800;color:#111}
  .comments-list{flex:1;overflow:auto;border-radius:8px;padding:8px;background:#f7f7f7}
  .comment{padding:8px;border-radius:8px;background:#fff;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,0.06)}
  .comment .meta{font-size:0.75rem;color:#666;margin-bottom:6px}
  .comment .body{font-size:0.9rem;color:#222;white-space:pre-wrap}
  .comment-input{display:flex;gap:8px;align-items:flex-start}
  .comment-input textarea{flex:1;min-height:64px;padding:8px;border-radius:8px;border:1px solid #ddd;resize:none}
  .comment-input .meta-input{width:120px;padding:6px;border-radius:8px;border:1px solid #ddd}
  .comment-actions{display:flex;gap:8px;justify-content:flex-end}

  /* responsive */
  @media (max-width:1000px){
    #modal-inner{flex-direction:column;align-items:center;padding:10px}
    .modal-left,.modal-right{width:100%}
    .modal-left .letter-frame{height:60vh}
    .modal-right{max-height:40vh;order:2;width:100%}
  }

  /* other small cosmetics */
  a.backlink{color:var(--gold);text-decoration:underline}
</style>
</head>
<body>

<header>
  <img class="banner" src="lettersbanner.jpg" alt="Letters Banner">
  <div class="header-text">
    <h1>Letters Wall</h1>
    <p>All submitted letters (portrait). Click any letter to open, like, comment, or delete your own.</p>
    <a class="backlink" href="index.html">← Back to Homepage</a>
  </div>
</header>

<section class="wall" id="letters-wall"></section>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div id="modal-inner" role="dialog" aria-modal="true">
    <button id="modal-close" class="btn-close">X</button>

    <div class="modal-left">
      <div class="letter-frame" id="modal-frame">
        <img id="modal-img" src="" alt="Letter image">
        <div id="modal-text"><p id="modal-text-p"></p></div>
      </div>

      <div class="modal-controls" id="modal-controls">
        <button id="modal-like" class="btn btn-like">❤ 0</button>
        <button id="modal-delete" class="btn btn-delete" style="display:none">Delete</button>
      </div>
    </div>

    <div class="modal-right">
      <div>
        <div class="comments-title">Comments</div>
        <div style="font-size:0.9rem;color:#444;margin-top:4px">Live comments — talk respectfully.</div>
      </div>

      <div class="comments-list" id="comments-list" aria-live="polite"></div>

      <div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="comment-author" class="meta-input" placeholder="Your name (optional)">
          <select id="comment-anonymity" style="padding:6px;border-radius:8px;border:1px solid #ddd">
            <option value="public">Show name</option>
            <option value="anon">Remain anonymous</option>
          </select>
        </div>
        <div class="comment-input">
          <textarea id="comment-text" placeholder="Write a comment..." maxlength="600"></textarea>
        </div>
        <div class="comment-actions">
          <button id="comment-submit" class="btn" style="background:var(--gold)">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer style="padding:24px 0;border-top:2px solid var(--gold);margin-top:18px">
  <p style="margin:6px 0">Created by <a href="https://x.com/R7_UNION" target="_blank" style="color:var(--gold);text-decoration:none">@R7_UNION</a></p>
  <img src="logo.jpg" alt="Logo" height="60">
</footer>

<script type="module">
/* Firebase v12 modular */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import {
  getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc,
  addDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* --- your firebase config (same as other pages) --- */
const firebaseConfig = {
  apiKey:"AIzaSyCM69r2wUibBFIFpML07Y5RUTrxHgonlSc",
  authDomain:"rii7e-sticky-notes-project.firebaseapp.com",
  projectId:"rii7e-sticky-notes-project",
  storageBucket:"rii7e-sticky-notes-project.firebasestorage.app",
  messagingSenderId:"962319162792",
  appId:"1:962319162792:web:8fad2b11c316766c8a119d"
};
initializeApp(firebaseConfig);
const db = getFirestore();

/* DOM elements */
const wall = document.getElementById('letters-wall');
const modal = document.getElementById('modal');
const modalInner = document.getElementById('modal-inner');
const modalImg = document.getElementById('modal-img');
const modalTextP = document.getElementById('modal-text-p');
const modalLike = document.getElementById('modal-like');
const modalDelete = document.getElementById('modal-delete');
const modalClose = document.getElementById('modal-close');
const commentsList = document.getElementById('comments-list');
const commentSubmit = document.getElementById('comment-submit');
const commentText = document.getElementById('comment-text');
const commentAuthor = document.getElementById('comment-author');
const commentAnonymity = document.getElementById('comment-anonymity');

let currentNote = null;
let commentsUnsub = null;
const userId = localStorage.getItem('userId') || (localStorage.setItem('userId', crypto.randomUUID()), localStorage.getItem('userId'));

/* Helpers */
const memberName = "letters"; // all letters go here
const notesColRef = collection(db,'notes',memberName,'memberNotes');

function createThumbnail(note) {
  const d = document.createElement('div');
  d.className = 'sticky-note';
  const img = document.createElement('img');
  img.src = note.img || '';
  img.alt = 'Letter';
  const label = document.createElement('div');
  label.className = 'label';
  label.textContent = (note.text||'').length > 120 ? (note.text||'').slice(0,120) + '…' : (note.text||'');
  d.appendChild(img);
  d.appendChild(label);
  d.onclick = () => openModal(note);
  // right-click to download png of the letter (rounded)
  d.addEventListener('contextmenu', async e => {
    e.preventDefault();
    try{
      const canvas = await html2canvas(d, { backgroundColor:null, useCORS:true });
      const radius = 16;
      const clipped = document.createElement('canvas');
      clipped.width = canvas.width;
      clipped.height = canvas.height;
      const ctx = clipped.getContext('2d');
      ctx.beginPath();
      ctx.moveTo(radius, 0);
      ctx.lineTo(clipped.width-radius, 0);
      ctx.quadraticCurveTo(clipped.width, 0, clipped.width, radius);
      ctx.lineTo(clipped.width, clipped.height-radius);
      ctx.quadraticCurveTo(clipped.width, clipped.height, clipped.width-radius, clipped.height);
      ctx.lineTo(radius, clipped.height);
      ctx.quadraticCurveTo(0, clipped.height, 0, clipped.height-radius);
      ctx.lineTo(0, radius);
      ctx.quadraticCurveTo(0,0,radius,0);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(canvas,0,0);
      const link = document.createElement('a');
      link.download = 'letter.png';
      link.href = clipped.toDataURL('image/png');
      link.click();
    }catch(err){
      console.error('download error', err);
    }
  });
  return d;
}

/* Render notes thumbnails in real time */
onSnapshot(notesColRef, snapshot => {
  wall.innerHTML = '';
  const notes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  // determine weekly top liked if you want (example kept from old logic)
  const currentWeek = Math.floor((new Date() - new Date('2025-09-04'))/(7*24*60*60*1000)) + 1;
  let maxLikes = -1, topId = null;
  notes.forEach(n => { if(n.week===currentWeek && (n.likes||0) > maxLikes){ maxLikes = n.likes||0; topId = n.id; }});
  notes.forEach(n => {
    const thumb = createThumbnail(n);
    if(n.id === topId) thumb.classList.add('top-note');
    wall.appendChild(thumb);
  });
});

/* Open modal for a note */
async function openModal(note) {
  currentNote = note;
  // fetch latest
  try {
    const docRef = doc(db,'notes',memberName,'memberNotes',note.id);
    const snap = await getDoc(docRef);
    if(snap.exists()) currentNote = { id: snap.id, ...snap.data() };
  } catch (e) { console.error(e); }

  // populate modal
  modalImg.src = currentNote.img || '';
  // overlay text centered; use note.color if present for color
  modalTextP.textContent = currentNote.text || '';
  modalTextP.style.color = currentNote.color || '#000';
  modalLike.textContent = `❤ ${currentNote.likes || 0}`;
  modalDelete.style.display = (currentNote.creator === userId) ? 'inline-block' : 'none';

  // open modal
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';

  // comments: subscribe to subcollection 'comments' under the note
  if (commentsUnsub) commentsUnsub(); // cleanup any prior
  const commentsCol = collection(doc(db,'notes',memberName,'memberNotes', currentNote.id), 'comments');
  const q = query(commentsCol, orderBy('timestamp','asc'));
  commentsUnsub = onSnapshot(q, snap => {
    commentsList.innerHTML = '';
    snap.docs.forEach(d => {
      const data = d.data();
      const el = document.createElement('div');
      el.className = 'comment';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const name = data.anonymous ? 'Anonymous' : (data.author || 'Anonymous');
      const time = new Date(data.timestamp || Date.now()).toLocaleString();
      meta.textContent = `${name} • ${time}`;
      const body = document.createElement('div');
      body.className = 'body';
      body.textContent = data.text || '';
      el.appendChild(meta);
      el.appendChild(body);
      commentsList.appendChild(el);
    });
    commentsList.scrollTop = commentsList.scrollHeight;
  }, err => {
    console.error('comments onSnapshot error', err);
  });
}

/* close modal */
function closeModal(){
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  if (commentsUnsub){ commentsUnsub(); commentsUnsub = null; }
  currentNote = null;
}
modalClose.addEventListener('click', closeModal);
modal.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});

/* Like handling (prevents double-like via localStorage) */
modalLike.addEventListener('click', async () => {
  if (!currentNote) return;
  const liked = JSON.parse(localStorage.getItem('likedNotes') || '[]');
  if (liked.includes(currentNote.id)){ alert('Already liked!'); return; }
  try {
    const noteDoc = doc(db,'notes',memberName,'memberNotes',currentNote.id);
    await updateDoc(noteDoc, { likes: (currentNote.likes || 0) + 1 });
    // update local UI quickly
    currentNote.likes = (currentNote.likes||0) + 1;
    modalLike.textContent = `❤ ${currentNote.likes}`;
    liked.push(currentNote.id);
    localStorage.setItem('likedNotes', JSON.stringify(liked));
  } catch (err) {
    console.error('like error', err);
    alert('Error while liking — try again.');
  }
});

/* Delete (only creator) */
modalDelete.addEventListener('click', async () => {
  if (!currentNote) return;
  if (!confirm('Delete this letter?')) return;
  try {
    await deleteDoc(doc(db,'notes',memberName,'memberNotes',currentNote.id));
    closeModal();
  } catch (err) {
    console.error('delete error', err);
    alert('Error deleting note.');
  }
});

/* Submit comment */
commentSubmit.addEventListener('click', async () => {
  if (!currentNote) return alert('Open a letter first');
  const text = commentText.value.trim();
  if (!text) return alert('Write a comment!');
  const anon = (commentAnonymity.value === 'anon');
  const author = commentAuthor.value.trim();
  try {
    const commentsColRef = collection(doc(db,'notes',memberName,'memberNotes',currentNote.id), 'comments');
    await addDoc(commentsColRef, {
      text,
      author: author || '',
      anonymous: anon,
      timestamp: Date.now(),
      creator: userId
    });
    commentText.value = '';
    // list will update in real-time via onSnapshot
  } catch (err) {
    console.error('comment submit error', err);
    alert('Error submitting comment.');
  }
});

/* Accessibility: Enter to submit comment (Ctrl+Enter also) */
commentText.addEventListener('keydown', (e) => {
  if ((e.key === 'Enter' && (e.ctrlKey || e.metaKey)) ) {
    commentSubmit.click();
  }
});

/* Initial load: ensure at least an index listener for letters exists (realtime) */
/* We already have onSnapshot above for notesColRef; if you'd prefer to limit to only portrait letters,
   ensure documents under notes/letters/memberNotes are created by the submit flow (from other pages). */

/* Done */
console.log('Letters page initialized');
</script>

</body>
</html>

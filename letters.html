<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RII7E Letters Wall</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<style>
:root {
  --gold: #d4af37;
  --bg: #000;
  --panel: #111;
  --muted: #ddd;
}

body {
  margin:0;
  padding:0;
  background: var(--bg);
  font-family: 'Playfair Display', serif;
  color: white;
}

header {
  display:flex; flex-direction:column; align-items:center;
  background:#000; border-bottom:3px solid var(--gold); padding: 12px;
}
header h1 {
  color: var(--gold); font-size:2rem; margin:8px 0;
}
main { padding:20px; }

.wall {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 14px;
}

.sticky-note {
  width: 180px;
  height: 230px;
  position: relative;
  cursor: pointer;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  border: 4px solid #FFA500; /* letters default color */
}

.sticky-note img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.sticky-note .text {
  position: absolute;
  top: 15%;
  left: 10%;
  right: 10%;
  bottom: 10%;
  color: black;
  font-size: 0.7rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  text-align: center;
  pointer-events: none;
  text-shadow: 1px 1px 3px white;
  overflow: auto;
}

.note-actions {
  position: absolute;
  bottom: 6px;
  left: 6px;
  right: 6px;
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  pointer-events: auto;
}

.note-actions button {
  background: var(--gold);
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 60;
  align-items: center;
  justify-content: center;
  padding: 10px;
  overflow: auto;
}

.modal-content {
  background: #fff;
  color: #000;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 90%;
  padding: 18px;
  position: relative;
}

.modal img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 8px;
}

.modal .text {
  margin-top: 12px;
  font-size: 0.9rem;
  text-align: center;
  white-space: pre-wrap;
}

.modal .comments {
  margin-top: 14px;
  max-height: 200px;
  overflow-y: auto;
  border-top: 1px solid #ccc;
  padding-top: 8px;
}

.comment {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.comment button {
  background: red;
  color: #fff;
  border: none;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 3px;
}

.comment-input {
  margin-top: 8px;
  display: flex;
  gap: 6px;
}

.comment-input input {
  flex: 1;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.comment-input button {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  background: var(--gold);
  cursor: pointer;
}
</style>
</head>
<body>

<header>
  <h1>Letters Wall</h1>
</header>

<main>
  <div class="wall" id="letters-wall">
    <!-- letters will appear here -->
  </div>
</main>

<div class="modal" id="modal">
  <div class="modal-content">
    <span id="modal-close" style="position:absolute;top:8px;right:12px;font-size:26px;cursor:pointer">&times;</span>
    <img id="modal-img" src="">
    <div class="text" id="modal-text"></div>

    <div class="note-actions">
      <button id="like-btn">❤️ Like (<span id="like-count">0</span>)</button>
      <button id="delete-btn" style="display:none;">Delete</button>
    </div>

    <div class="comments" id="comments"></div>

    <div class="comment-input">
      <input type="text" id="comment-input" placeholder="Write a comment...">
      <button id="comment-submit">Post</button>
    </div>
  </div>
</div>

<script type="module">
// ---------------- Firebase ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCM69r2wUibBFIFpML07Y5RUTrxHgonlSc",
  authDomain: "rii7e-sticky-notes-project.firebaseapp.com",
  projectId: "rii7e-sticky-notes-project",
  storageBucket: "rii7e-sticky-notes-project.firebasestorage.app",
  messagingSenderId: "962319162792",
  appId: "1:962319162792:web:8fad2b11c316766c8a119d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const userId = localStorage.getItem('userId') || crypto.randomUUID();
localStorage.setItem('userId', userId);

const lettersWall = document.getElementById('letters-wall');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modal-img');
const modalText = document.getElementById('modal-text');
const modalClose = document.getElementById('modal-close');
const likeBtn = document.getElementById('like-btn');
const likeCount = document.getElementById('like-count');
const deleteBtn = document.getElementById('delete-btn');
const commentsDiv = document.getElementById('comments');
const commentInput = document.getElementById('comment-input');
const commentSubmit = document.getElementById('comment-submit');

let currentLetterId = null;

// ----------------- Render Letters -----------------
const lettersCol = collection(db, 'notes', 'letters', 'memberNotes');

onSnapshot(lettersCol, snapshot => {
  lettersWall.innerHTML = '';
  snapshot.docs.forEach(docSnap => {
    const data = docSnap.data();
    const noteDiv = document.createElement('div');
    noteDiv.className = 'sticky-note';
    noteDiv.dataset.id = docSnap.id;
    noteDiv.innerHTML = `<img src="${data.img}"><div class="text">${data.text}</div>`;
    noteDiv.onclick = () => openModal(docSnap.id, data);
    lettersWall.appendChild(noteDiv);
  });
});

// ----------------- Modal -----------------
function openModal(id, data) {
  currentLetterId = id;
  modalImg.src = data.img;
  modalText.textContent = data.text;
  likeCount.textContent = data.likes || 0;
  deleteBtn.style.display = (data.creator===userId) ? 'inline-block' : 'none';

  // Load comments
  const commentsCol = collection(db, 'notes', 'letters', 'memberNotes', id, 'comments');
  onSnapshot(commentsCol, snapshot => {
    commentsDiv.innerHTML = '';
    snapshot.docs.forEach(cDoc => {
      const cData = cDoc.data();
      const cEl = document.createElement('div');
      cEl.className = 'comment';
      cEl.dataset.id = cDoc.id;
      cEl.textContent = cData.text;
      if(cData.creator===userId){
        const delBtn = document.createElement('button');
        delBtn.textContent = '×';
        delBtn.onclick = async (e)=>{
          e.stopPropagation();
          await deleteDoc(doc(db,'notes','letters','memberNotes',id,'comments',cDoc.id));
        };
        cEl.appendChild(delBtn);
      }
      commentsDiv.appendChild(cEl);
    });
  });

  modal.style.display = 'flex';
}

modalClose.onclick = ()=> modal.style.display='none';
window.onclick = e=> { if(e.target===modal) modal.style.display='none'; };

// ----------------- Like -----------------
likeBtn.onclick = async ()=>{
  if(!currentLetterId) return;
  const docRef = doc(db,'notes','letters','memberNotes',currentLetterId);
  const docSnap = await docRef.get();
  const currentLikes = (docSnap.data()?.likes)||0;
  await updateDoc(docRef, { likes: currentLikes+1 });
};

// ----------------- Delete -----------------
deleteBtn.onclick = async ()=>{
  if(!currentLetterId) return;
  if(confirm('Delete this letter?')){
    await deleteDoc(doc(db,'notes','letters','memberNotes',currentLetterId));
    modal.style.display='none';
  }
};

// ----------------- Comments -----------------
commentSubmit.onclick = async ()=>{
  const text = commentInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,'notes','letters','memberNotes',currentLetterId,'comments'), {
    text,
    creator: userId,
    timestamp: serverTimestamp()
  });
  commentInput.value='';
};

</script>
</body>
</html>
